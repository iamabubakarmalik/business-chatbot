(function () {
    const script = document.currentScript;
    const clientId = script.getAttribute("data-client");

    // Chatbox UI
    const box = document.createElement("div");
    box.innerHTML = `
        <div id="cb-box" style="
            position:fixed;
            bottom:20px;
            right:20px;
            width:300px;
            background:white;
            border:1px solid #ccc;
            font-family:Arial;
            z-index:9999;
        ">
            <div style="background:#333;color:white;padding:8px;">
                ðŸ¤– Chat with us
            </div>
            <div id="cb-messages" style="height:200px;overflow:auto;padding:8px;"></div>
            <input id="cb-input" placeholder="Type here..."
                   style="width:100%;padding:6px;border:none;border-top:1px solid #ccc;">
        </div>
    `;
    document.body.appendChild(box);

    const input = document.getElementById("cb-input");
    const messages = document.getElementById("cb-messages");

    function addMsg(sender, text) {
        const div = document.createElement("div");
        div.innerHTML = `<b>${sender}:</b> ${text}`;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    input.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
            const msg = input.value;
            input.value = "";
            addMsg("You", msg);

            fetch("http://127.0.0.1:5000/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: msg,
                    client_id: clientId,
                    user_id: "web-user"
                })
            })
            .then(res => res.json())
            .then(data => {
                addMsg("Bot", data.reply);
            });
        }
    });
})();

