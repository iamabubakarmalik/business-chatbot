from flask import Flask, request, jsonify, render_template
from flask_cors import CORS
import json
import uuid
import re

# ======================
# ADMIN CREDENTIALS
# ======================
ADMIN_USERNAME = "admin"
ADMIN_PASSWORD = "12345"
ADMIN_TOKEN = "admin-secret"

app = Flask(__name__)
CORS(app)

# ======================
# MEMORY
# ======================
user_memory = {}

# ======================
# FILES
# ======================
CLIENT_FILE = "clients.json"
LEADS_FILE = "leads.json"

# ======================
# HELPERS
# ======================
def load_clients():
    try:
        with open(CLIENT_FILE, "r") as f:
            return json.load(f)
    except:
        return {}

def save_clients(data):
    with open(CLIENT_FILE, "w") as f:
        json.dump(data, f, indent=2)

def load_leads():
    try:
        with open(LEADS_FILE, "r") as f:
            return json.load(f)
    except:
        return []

def save_leads(leads):
    with open(LEADS_FILE, "w") as f:
        json.dump(leads, f, indent=2)

# ======================
# ADMIN PAGE
# ======================
@app.route("/admin")
def admin_page():
    return render_template("admin.html")

# ======================
# ADMIN LOGIN
# ======================
@app.route("/admin/login", methods=["POST"])
def admin_login():
    data = request.get_json()

    if (
        data.get("username") == ADMIN_USERNAME and
        data.get("password") == ADMIN_PASSWORD
    ):
        return jsonify({
            "success": True,
            "token": ADMIN_TOKEN
        })

    return jsonify({"success": False}), 401

# ======================
# PROTECTED LEADS
# ======================
@app.route("/admin/leads")
def admin_leads():
    auth = request.headers.get("Authorization")

    if auth != ADMIN_TOKEN:
        return jsonify({"error": "Unauthorized"}), 403

    return jsonify(load_leads())

# ======================
# ADD CLIENT
# ======================
@app.route("/admin/add-client", methods=["POST"])
def add_client():
    data = request.get_json()

    client_id = str(uuid.uuid4())[:8]

    clients = load_clients()
    clients[client_id] = {
        "name": data.get("name"),
        "plan": data.get("plan", "free")
    }

    save_clients(clients)

    return jsonify({
        "client_id": client_id
    })

# ======================
# CHAT API
# ======================
@app.route("/chat", methods=["POST"])
def chat():
    data = request.get_json()

    msg = data.get("message", "")
    client_id = data.get("client_id")
    user_id = data.get("user_id", "guest")

    clients = load_clients()
    if client_id not in clients:
        return jsonify({"reply": "Invalid client"})

    if user_id not in user_memory:
        user_memory[user_id] = {}

    msg_lower = msg.lower()

    # Name
    if "my name is" in msg_lower:
        name = msg.split("is")[-1].strip()
        user_memory[user_id]["name"] = name
        return jsonify({"reply": f"Nice to meet you {name} ðŸ˜Š"})

    # Email
    email_match = re.search(
        r"[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}",
        msg
    )

    if email_match:
        email = email_match.group()
        name = user_memory[user_id].get("name", "Unknown")

        leads = load_leads()
        leads.append({
            "name": name,
            "email": email,
            "client_id": client_id
        })
        save_leads(leads)

        return jsonify({"reply": "Email saved successfully ðŸ“§"})

    # Default replies
    reply = "How can I help you?"
    if "price" in msg_lower:
        reply = "Plans start from $29/month."
    elif "service" in msg_lower:
        reply = "We build AI business chatbots."

    name = user_memory[user_id].get("name")
    if name:
        reply = f"{name}, {reply}"

    return jsonify({"reply": reply})

@app.route("/admin/leads/<client_id>")
def admin_client_leads(client_id):
    auth = request.headers.get("Authorization")
    if auth != ADMIN_TOKEN:
        return jsonify({"error": "Unauthorized"}), 403

    leads = load_leads()
    client_leads = [l for l in leads if l["client_id"] == client_id]

    return jsonify(client_leads)

# ======================
# RUN SERVER
# ======================
if __name__ == "__main__":
    app.run(debug=True)
